# ─────────────────────────────────────────────
# Hypridle — Idle & Power Management
# ─────────────────────────────────────────────
# Documentation: https://wiki.hyprland.org/Hypridle/

# ─────────────── Idle Timing Variables ───────────────
$timeout_screensaver    = 150  # 2.5 min
$timeout_lock           = 300  # 5 min
$timeout_screen_off     = 330  # 5.5 min
$timeout_kbd_backlight  = 50   # 50 sec

# ─────────────── Battery-Aware Mode (Optional) ───────────────
# Set to 1 for aggressive timeouts when on battery
$battery_mode = 0

# Function to check if on battery (evaluates dynamically)
$is_on_battery = bash -c '[ "$(cat /sys/class/power_supply/*/status | grep Discharging)" ]'

# ─────────────── General Commands ───────────────
general {
    lock_cmd         = omarchy-lock-screen                   # Lock screen & trigger 1Password
    before_sleep_cmd = loginctl lock-session                 # Lock before suspend
    after_sleep_cmd  = hyprctl dispatch dpms on              # Avoid double keypress to wake
    on_unlock_cmd    = omarchy-restart-waybar                # Prevent Waybar stacking after wake
}

# ─────────────── Screensaver Listener ───────────────
listener {
    timeout     = $timeout_screensaver
    on-timeout  = omarchy-launch-screensaver
}

# ─────────────── Session Lock Listener ───────────────
listener {
    timeout     = $timeout_lock
    # on-timeout  = loginctl lock-session
    on-timeout  = pidof hyprlock
}

# ─────────────── Screen Off / Fade Listener ───────────────
listener {
    timeout     = $timeout_screen_off
    on-timeout  = bash -c '
        hyprctl --batch "keyword animations:enabled 0; dispatch dpms off"
        sleep 0.2
        hyprctl --batch "dispatch dpms off"
    '
    on-resume   = bash -c '
        hyprctl --batch "dispatch dpms on"
        sleep 0.2
        hyprctl --batch "keyword animations:enabled 1"
        brightnessctl -r
    '
}

# ─────────────── Keyboard Backlight Listener ───────────────
listener {
    timeout     = $timeout_kbd_backlight
    on-timeout  = brightnessctl -sd rgb:kbd_backlight set 0
    on-resume   = brightnessctl -rd rgb:kbd_backlight
}

# ─────────────── Optional Battery-Aware Overrides ───────────────
# Applied only if battery_mode is enabled and on battery
listener {
    timeout     = 90
    on-timeout  = loginctl lock-session
    only-when   = $battery_mode == 1 && $is_on_battery
}
